---
title: "7-iml"
author: "Bernard"
date: "2021-12-02"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Load package

```{r}

# Helper
library(tidyverse)
library(data.table)
library (cowplot)
library (officer)
library (flextable)

# ML
library(mlr3)
library(mlr3learners)
library(mlr3tuning)
library(mlr3viz)
library(mlr3fselect)
library(mlr3pipelines)
library(mlr3hyperband)
library(iml)
library(MASS)
library(MLmetrics)

# Parallel
library (future)
```

# Import

```{r}
bmr <- readRDS("output/resampling_models.RDS")

bmr2 <- as.data.table(bmr) %>%
  mutate (Model = mlr3misc::map (learner, "model"))

dat <- readRDS("output/df.RDS")

np_dat <- bind_rows(dat$df_list$np$train_imp, dat$df_list$np$test_imp) #%>% group_by(outcome) %>% sample_n(50)
ap_dat <- bind_rows(dat$df_list$ap$train_imp, dat$df_list$ap$test_imp) #%>% group_by(outcome) %>% sample_n(50)
dis_dat <- bind_rows(dat$df_list$dis$train_imp, dat$df_list$dis$test_imp) #%>% group_by(outcome) %>% sample_n(50)

df <- np_dat
x <- df[which(names(df) != "outcome")][,-1]
y <- df$outcome
```

# Extract neck pain model

```{r}
# Neck pain, ANN model
m <- Predictor$new(bmr2$Model[[6]][[1]],
                   data = x,
                   y = y)

```

# IMLs

## PDP

```{r}
pdp <- FeatureEffects$new(m,
                             method = "pdp")

plot(pdp, features = names (x))
```

## ICE

```{r}
ice <- FeatureEffects$new(m,
                             method = "ice")

plot(ice, features = names (x)[1:5])
```


## Shapley

```{r}
shapley <- Shapley$new(m, x.interest = x)
plot(shapley)
```



```{r}

effect = FeatureEffects$new(m)
df <- ap_dat
x <- df[which(names(df) != "outcome")]
y <- df$outcome

for (n in seq_along (bmr2$Model)) {

  bmr2$iml_model[[n]] <- Predictor$new(bmr2$Model[[n]][[1]], data = x, y = y)

}

for (n in seq_along (bmr2$Model)[-c(1, 8, 15)]) {

  bmr2$effect [[n]] <- FeatureImp$new(bmr2$iml_model[[n]], loss = "ce")

}

featimp <- list()
featimp_gg <- list()

for (n in seq_along (bmr2$Model)[-c(1, 8, 15)]) {

  featimp [[n]] <- FeatureImp$new(bmr2$iml_model[[n]], loss = "ce")

}


for (n in c(2, 3, 5, 6, 7, 9, 10, 12, 13, 14, 16, 17, 19, 20, 21)) {

  featimp_gg[[n]] <- featimp[[n]]$plot()

}

mody_gg <- function (x) {

  x +
    xlim (0.8, 2.5)
}

featimp_gg <- featimp_gg %>%
  purrr::discard(is.null) %>%
  purrr::map (~ .x +
                xlim (0.8, 3) +
                theme_cowplot() +
                theme (axis.text.y = element_text(size = 10)))

pdf ("output/featimp.pdf", height = 20, width = 8)
plot_grid(plotlist = featimp_gg,
          ncol = 2,
          nrow = 8)

dev.off()
```

